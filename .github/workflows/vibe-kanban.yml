name: Vibe Kanban

on:
  push:
    branches:
      - 'vk/**'
  create: {}
  workflow_dispatch:
    inputs:
      branch:
        description: 'vk/* branch to ensure PR for'
        required: false
        default: ''
      pr_number:
        description: 'Manual: run post-merge log/update for this PR number'
        required: false
        default: ''
  pull_request:
    types: [opened, edited, synchronize, reopened, closed]

permissions:
  contents: write
  pull-requests: write

jobs:
  open-or-update-pr:
    name: Ensure PR for vk/*
    # Run when:
    # - vk/* branch is pushed
    # - a vk/* branch is created (even if no further push triggers)
    # - manually dispatched with an explicit branch input
    if: |
      github.event_name == 'push' || github.event_name == 'create' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Create or update PR from vk/* to main
        id: ensure_pr
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ github.event.inputs.branch }}
        with:
          script: |
            // Resolve branch depending on event
            let branch = '';
            if (context.eventName === 'push') {
              branch = context.ref.replace('refs/heads/', '');
            } else if (context.eventName === 'create' && context.payload.ref_type === 'branch') {
              branch = context.payload.ref || '';
            } else if (context.eventName === 'workflow_dispatch') {
              branch = (process.env.BRANCH || '').trim();
            }

            if (!branch || !branch.startsWith('vk/')) {
              core.info(`Skip: not a vk/* branch (resolved='${branch}')`);
              try { core.setOutput('pr_number', ''); core.setOutput('branch', branch || ''); } catch {}
              return;
            }
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');

            // Try to find existing open PR for this head
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:${branch}` });
            let pr = prs.data[0];

            if (!pr) {
              // Derive title from branch: vk/{cardId}-{slug...}
              const short = branch.split('/').slice(1).join('/');
              const title = `VK: ${short}`;

              // Load PR template from repo
              let body = '';
              try {
                const res = await github.rest.repos.getContent({ owner, repo, path: '.github/pull_request_template.md' });
                const buff = Buffer.from(res.data.content, res.data.encoding);
                body = buff.toString('utf8').replace('{{ branch }}', branch);
              } catch (e) {
                body = `Vibe-Kanban PR for branch ${branch}`;
              }

              const created = await github.rest.pulls.create({ owner, repo, base: 'main', head: branch, title, body, draft: false });
              pr = created.data;
            }

            // Ensure 'vk' label exists and is applied
            const labelName = 'vk';
            async function ensureLabel() {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: labelName });
              } catch (err) {
                if (err.status === 404) {
                  await github.rest.issues.createLabel({ owner, repo, name: labelName, color: '0e8a16', description: 'vibe-kanban' });
                } else { throw err; }
              }
            }
            await ensureLabel();
            await github.rest.issues.addLabels({ owner, repo, issue_number: pr.number, labels: [labelName] });

            // Expose outputs for downstream steps in push runs
            core.setOutput('pr_number', String(pr.number));
            core.setOutput('branch', branch);
            core.setOutput('owner', owner);
            core.setOutput('repo', repo);

      - name: Checkout (vk push)
        if: ${{ steps.ensure_pr.outputs.pr_number }}
        uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Set up Python
        if: ${{ steps.ensure_pr.outputs.pr_number }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        if: ${{ steps.ensure_pr.outputs.pr_number }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build web index and pages (push)
        if: ${{ steps.ensure_pr.outputs.pr_number }}
        run: |
          set -e
          python scripts/build_index.py --output web/data/index.json --shard monthly || true
          python scripts/build_pages.py --out-dir web/p || true

      - name: Upload Pages artifact (web/) [push]
        if: ${{ steps.ensure_pr.outputs.pr_number }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: web

      - name: Show local preview instructions (artifact download) [push]
        if: ${{ steps.ensure_pr.outputs.pr_number }}
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "### Local Preview (no Pages deploy)" >> "$GITHUB_STEP_SUMMARY"
          echo "Run these commands locally to preview this PR build:" >> "$GITHUB_STEP_SUMMARY"
          echo '' >> "$GITHUB_STEP_SUMMARY"
          echo '\`\`\`bash' >> "$GITHUB_STEP_SUMMARY"
          echo "gh run download ${RUN_ID} -n github-pages -D web-preview" >> "$GITHUB_STEP_SUMMARY"
          echo "tar -xf web-preview/artifact.tar -C web-preview" >> "$GITHUB_STEP_SUMMARY"
          echo "python3 -m http.server -d web-preview 8080" >> "$GITHUB_STEP_SUMMARY"
          echo "# then open http://localhost:8080" >> "$GITHUB_STEP_SUMMARY"
          echo '\`\`\`' >> "$GITHUB_STEP_SUMMARY"

      - name: Update PR body with local preview instructions [push]
        if: ${{ steps.ensure_pr.outputs.pr_number }}
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ steps.ensure_pr.outputs.pr_number }}
        with:
          script: |
            const number = parseInt(process.env.PR_NUMBER, 10);
            const runId = context.runId;
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const begin = '<!-- vk:local-preview:begin -->';
            const end = '<!-- vk:local-preview:end -->';
            const lines = [];
            lines.push('### Local Preview (no Pages deploy)');
            lines.push('Download artifact from this workflow run and serve locally:');
            lines.push('');
            lines.push('```bash');
            lines.push(`gh run download ${runId} -R ${owner}/${repo} -n github-pages -D web-preview`);
            lines.push('tar -xf web-preview/artifact.tar -C web-preview');
            lines.push('python3 -m http.server -d web-preview 8080');
            lines.push('# open http://localhost:8080');
            lines.push('```');
            const block = `${begin}\n${lines.join('\n')}\n${end}`;
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: number });
            let body = pr.data.body || '';
            if (body.includes(begin) && body.includes(end)) {
              body = body.replace(new RegExp(`${begin}[\\s\\S]*?${end}`), block);
            } else {
              body = body ? `${body}\n\n${block}` : block;
            }
            await github.rest.pulls.update({ owner, repo, pull_number: number, body });

  augment-pr-body:
    name: Augment PR body with VK context
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'vk/') && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Inject VK context and TODO checklist
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const branch = pr.head.ref;
            const number = pr.number;

            // Try to parse cardId from branch vk/{cardId}-{slug}
            let cardId = null;
            const m = branch.match(/^vk\/([^\/-]+)[\/-]?.*$/);
            if (m) cardId = m[1];

            // Load TODO section (optional)
            let checklist = '';
            try {
              const res = await github.rest.repos.getContent({ owner, repo, path: 'docs/TODO.md' });
              const text = Buffer.from(res.data.content, res.data.encoding).toString('utf8');
              const lines = text.split(/\r?\n/);
              // Find section header
              const header = '## 내일 작업(자동화: vibe-kanban)';
              let i = lines.findIndex(l => l.trim() === header);
              if (i >= 0) {
                i += 1;
                const items = [];
                for (; i < lines.length; i++) {
                  const line = lines[i];
                  if (line.startsWith('## ')) break;
                  const m2 = line.match(/^\s*- \[ \] (.+)$/);
                  if (m2) items.push(`- [ ] ${m2[1]}`);
                }
                if (items.length) {
                  checklist = items.join('\n');
                }
              }
            } catch (e) {
              // ignore if TODO.md missing
            }

            const begin = '<!-- vk:begin -->';
            const end = '<!-- vk:end -->';
            const parts = [];
            parts.push('### VK Context');
            parts.push(`- Branch: \`${branch}\``);
            if (cardId) {
              const format = process.env.VK_CARD_URL_FORMAT || '';
              if (format.includes('{id}')) {
                const url = format.replace('{id}', cardId);
                parts.push(`- Card: [${cardId}](${url})`);
              } else {
                parts.push(`- Card: ${cardId}`);
              }
            }
            if (checklist) {
              parts.push('\n### TODO Checklist');
              parts.push(checklist);
              parts.push('\n> Check items handled in this PR. On merge, docs/TODO.md will be updated to match checked items.');
            }
            const block = `${begin}\n${parts.join('\n')}\n${end}`;

            let body = pr.body || '';
            if (body.includes(begin) && body.includes(end)) {
              body = body.replace(new RegExp(`${begin}[\s\S]*?${end}`), block);
            } else {
              body = body ? `${body}\n\n${block}` : block;
            }

            await github.rest.pulls.update({ owner, repo, pull_number: number, body });

  preview-deploy:
    name: Local preview (vk/* PR)
    if: github.event_name == 'pull_request' && startsWith(github.head_ref, 'vk/') && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build web index and pages (no crawl)
        run: |
          set -e
          python scripts/build_index.py --output web/data/index.json --shard monthly || true
          python scripts/build_pages.py --out-dir web/p || true

      - name: Upload Pages artifact (web/)
        uses: actions/upload-pages-artifact@v3
        with:
          path: web

      - name: Show local preview instructions (artifact download)
        env:
          RUN_ID: ${{ github.run_id }}
        run: |
          echo "### Local Preview (no Pages deploy)" >> "$GITHUB_STEP_SUMMARY"
          echo "Run these commands locally to preview this PR build:" >> "$GITHUB_STEP_SUMMARY"
          echo '' >> "$GITHUB_STEP_SUMMARY"
          echo '\`\`\`bash' >> "$GITHUB_STEP_SUMMARY"
          echo "gh run download ${RUN_ID} -n github-pages -D web-preview" >> "$GITHUB_STEP_SUMMARY"
          echo "tar -xf web-preview/artifact.tar -C web-preview" >> "$GITHUB_STEP_SUMMARY"
          echo "python3 -m http.server -d web-preview 8080" >> "$GITHUB_STEP_SUMMARY"
          echo "# then open http://localhost:8080" >> "$GITHUB_STEP_SUMMARY"
          echo '\`\`\`' >> "$GITHUB_STEP_SUMMARY"

      - name: Update PR body with local preview instructions
        uses: actions/github-script@v7
        with:
          script: |
            const number = context.payload.pull_request.number;
            const runId = context.runId;
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const begin = '<!-- vk:local-preview:begin -->';
            const end = '<!-- vk:local-preview:end -->';
            const lines = [];
            lines.push('### Local Preview (no Pages deploy)');
            lines.push('Download artifact from this workflow run and serve locally:');
            lines.push('');
            lines.push('```bash');
            lines.push(`gh run download ${runId} -R ${owner}/${repo} -n github-pages -D web-preview`);
            lines.push('tar -xf web-preview/artifact.tar -C web-preview');
            lines.push('python3 -m http.server -d web-preview 8080');
            lines.push('# open http://localhost:8080');
            lines.push('```');
            const block = `${begin}\n${lines.join('\n')}\n${end}`;
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: number });
            let body = pr.data.body || '';
            if (body.includes(begin) && body.includes(end)) {
              body = body.replace(new RegExp(`${begin}[\\s\\S]*?${end}`), block);
            } else {
              body = body ? `${body}\n\n${block}` : block;
            }
            await github.rest.pulls.update({ owner, repo, pull_number: number, body });
          

  log-merge:
    name: Log VK merge to Chat-Log
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true && startsWith(github.head_ref, 'vk/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Update TODO.md from checked items in PR body
        run: |
          # Safely write PR body without interpreting backticks or code blocks
          cat > pr_body.txt <<'PRBODY'
          ${{ github.event.pull_request.body }}
          PRBODY
          python - << 'PY'
          import re, sys
          from pathlib import Path
          body = Path('pr_body.txt').read_text(encoding='utf-8')
          # PR 본문에서 체크된 항목 수집
          checked_raw = []
          for line in body.splitlines():
            m = re.match(r"\s*- \[x\] (.+)", line, re.I)
            if m:
              checked_raw.append(m.group(1).strip())
          if not checked_raw:
            sys.exit(0)
          # 정규화: 백틱/공백/화살표/하이픈/스마트따옴표 통일
          def norm(s: str) -> str:
            s = s.strip()
            s = s.replace('`','')
            s = re.sub(r'[\u2018\u2019\u201C\u201D]', '"', s)
            s = re.sub(r'[–—−]', '-', s)
            s = s.replace('→', '->')
            s = re.sub(r'\s+', ' ', s)
            return s
          checked = { norm(x) for x in checked_raw }
          p = Path('docs/TODO.md')
          if not p.exists():
            sys.exit(0)
          text = p.read_text(encoding='utf-8')
          lines = text.splitlines()
          # 대상 섹션 범위 한정
          header = '## 내일 작업(자동화: vibe-kanban)'
          try:
            start = lines.index(header)
          except ValueError:
            start = -1
          end = len(lines)
          if start >= 0:
            for i in range(start+1, len(lines)):
              if lines[i].startswith('## '):
                end = i
                break
          def toggle(line: str) -> str:
            m = re.match(r"(\s*- )\[ \] (.+)$", line)
            if not m:
              return line
            prefix, item = m.groups()
            if norm(item) in checked:
              return f"{prefix}[x] {item}"
            return line
          if start >= 0:
            lines[start+1:end] = [toggle(ln) for ln in lines[start+1:end]]
          else:
            lines = [toggle(ln) for ln in lines]
          new = "\n".join(lines) + "\n"
          if new != text:
            p.write_text(new, encoding='utf-8')
          PY

      - name: Update Chat-Log.md
        run: |
          python scripts/update_chat_log.py \
            --pr-number "${{ github.event.pull_request.number }}" \
            --branch "${{ github.event.pull_request.head.ref }}" \
            --title "${{ github.event.pull_request.title }}" \
            --url "${{ github.event.pull_request.html_url }}"

      - name: Commit Chat-Log update
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            docs: VK merge log and TODO sync for ${{ github.event.pull_request.head.ref }} (PR #${{ github.event.pull_request.number }})
          file_pattern: |
            docs/Chat-Log.md
            docs/TODO.md
          branch: main
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com

  manual-log-merge:
    name: Manual log merge (dispatch)
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.pr_number != ''
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch PR details
        id: get_pr
        uses: actions/github-script@v7
        env:
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
        with:
          script: |
            const raw = process.env.PR_NUMBER || (context.payload && context.payload.inputs && context.payload.inputs.pr_number) || '';
            const prNumber = parseInt(String(raw), 10);
            if (!prNumber || Number.isNaN(prNumber)) {
              core.setFailed('Missing or invalid PR number');
              return;
            }
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');
            const pr = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            const fs = require('fs');
            fs.writeFileSync('pr_body.txt', pr.data.body || '', { encoding: 'utf-8' });
            core.setOutput('body', pr.data.body || '');
            core.setOutput('number', String(pr.data.number));
            core.setOutput('branch', pr.data.head.ref);
            core.setOutput('title', pr.data.title || '');
            core.setOutput('url', pr.data.html_url || '');

      - name: Update TODO.md from checked items in PR body (manual)
        run: |
          python - << 'PY'
          import re, sys
          from pathlib import Path
          body = Path('pr_body.txt').read_text(encoding='utf-8')
          checked_raw = []
          for line in body.splitlines():
            m = re.match(r"\s*- \[x\] (.+)", line, re.I)
            if m:
              checked_raw.append(m.group(1).strip())
          if not checked_raw:
            sys.exit(0)
          def norm(s: str) -> str:
            s = s.strip()
            s = s.replace('`','')
            s = re.sub(r'[\u2018\u2019\u201C\u201D]', '"', s)
            s = re.sub(r'[–—−]', '-', s)
            s = s.replace('→', '->')
            s = re.sub(r'\s+', ' ', s)
            return s
          checked = { norm(x) for x in checked_raw }
          p = Path('docs/TODO.md')
          if not p.exists():
            sys.exit(0)
          text = p.read_text(encoding='utf-8')
          lines = text.splitlines()
          header = '## 내일 작업(자동화: vibe-kanban)'
          try:
            start = lines.index(header)
          except ValueError:
            start = -1
          end = len(lines)
          if start >= 0:
            for i in range(start+1, len(lines)):
              if lines[i].startswith('## '):
                end = i
                break
          def toggle(line: str) -> str:
            m = re.match(r"(\s*- )\[ \] (.+)$", line)
            if not m:
              return line
            prefix, item = m.groups()
            if norm(item) in checked:
              return f"{prefix}[x] {item}"
            return line
          if start >= 0:
            lines[start+1:end] = [toggle(ln) for ln in lines[start+1:end]]
          else:
            lines = [toggle(ln) for ln in lines]
          new = "\n".join(lines) + "\n"
          if new != text:
            p.write_text(new, encoding='utf-8')
          PY

      - name: Update Chat-Log.md (manual)
        run: |
          python scripts/update_chat_log.py \
            --pr-number "${{ steps.get_pr.outputs.number }}" \
            --branch "${{ steps.get_pr.outputs.branch }}" \
            --title "${{ steps.get_pr.outputs.title }}" \
            --url "${{ steps.get_pr.outputs.url }}"

      - name: Commit Chat-Log update (manual)
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: |
            docs: VK merge log and TODO sync (manual) for PR #${{ steps.get_pr.outputs.number }}
          file_pattern: |
            docs/Chat-Log.md
            docs/TODO.md
          branch: main
          commit_user_name: github-actions[bot]
          commit_user_email: 41898282+github-actions[bot]@users.noreply.github.com
